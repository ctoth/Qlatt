# Pages 120-159 Notes

## Chapters/Sections Covered
- **Section 2.3** Voice Pulse Modeling (continued from earlier pages)
  - Synthesis subsection (p. 141)
  - Transformations subsection (p. 141)
  - Voice Signals subsection (p. 141)
  - Unvoiced Signals subsection (p. 142)
  - Discussion subsection (p. 142-143)
- **Section 2.3.3** Voice Pulse Modeling Applications (p. 149)
  - Voice Transformation Plug-ins
  - Real-Time Museum Installations
  - Web Applications
  - Video Games
- **Section 2.4** Computational Cost (p. 151-157)
  - Case Study: Wide-Band Voice Pulse Modeling (WBVPM)
- **Section 2.5** Spectral Voice Model (p. 158-160)
  - **Section 2.5.1** Modeling the Magnitude Envelope (p. 158)
    - EpR Source Filter
    - EpR Vocal Tract Filter

## Key Findings

### WBVPM Analysis and Synthesis
- Wide-band Voice Pulse Modeling (WBVPM) combines advantages of time-domain and frequency-domain methods
- WBVPM represents voice pulses as sets of sinusoids providing independent control of harmonic and noisy components
- Window adapted to cover certain number of pitch periods provides good time-frequency resolution tradeoff
- WBVPM is essentially pitch-synchronous but obtains best results when pulse onsets match actual glottal pulse onsets
- Narrow-band analysis with Hanning window adapted to 3-5 periods is recommended

### Harmonic Estimation Errors (from figures 2.74-2.82)
- Different discontinuity correction factors tested (0.2, 0.3)
- Amplitude errors in dB shown for different pitch scenarios
- Phase errors in radians tracked across harmonics
- T=512 samples used in experiments
- Errors increase for higher harmonics and larger pitch variations

### WBVPM vs Standard Sinusoidal Model Comparison (Figs 2.87-2.88)
- WBVPM residual is -11.1494 dB below standard sinusoidal model residual
- For synthetic signals with 10 harmonics, pitch modulated by 30% and amplitude modulated by 15 dB
- Sampling rate: 44.1 kHz
- Window sizes tested: 1, 2, 3, 4 T0 periods

### Real Audio Testing Results
- Female singing "yacht" with scoop and vibrato (Fig 2.89): Wide-band residual 5.9 dB lower than narrow-band with fixed window, 12.44 dB lower than narrow-band with 2049 samples
- Low pitch male speech (Fig 2.90): Wide-band 2.81 dB lower than narrow-band with adapted window, 2.07 dB lower than fixed window
- Female vibrato singing (Fig 2.91): Wide-band 6.3 dB lower with window adapted to 5 periods, 15.14 dB lower than fixed 2049 samples
- Male three notes with pitch transitions (Fig 2.92): Wide-band 0.6 dB lower than narrow-band adapted, 0.63 dB lower than fixed window
- Tenor with strong vibrato (Fig 2.93): Wide-band 6.49 dB lower than narrow-band adapted (4 periods), 15.33 dB lower than fixed 2049 samples

### Computational Cost Analysis
- Pitch-synchronous algorithms with adapted window achieve nearly constant computational cost independent of fundamental frequency
- Processing frame rate: constant (phase-vocoder, SMS) or pitch-synchronous (PSSM, TD-PSOLA)
- Window size: constant (phase-vocoder) or pitch-adapted (SMS, PSSM, TD-PSOLA)
- WBVPM achieves 4-5x real-time performance in frequency range 20Hz-1kHz
- Between 13-20Hz performance is flat at ~4.5x real-time
- Above 100Hz performance stabilizes around 3.5-4x real-time

### EpR Voice Model (Excitation plus Resonances)
- Three cascaded filters: voice source + vocal tract resonances + residual envelope
- Voice source modeled as exponential decay curve plus one resonance below first formant
- Based on Klatt 1980 formant synthesizer approach
- EpR can perfectly reproduce all nuances of harmonic envelope

## Equations Found

### Computational Cost (p. 152)
$$C_{alg} = m \cdot C_{segment}^{alg}$$
(Eq. 2.101)

Where:
- $C_{alg}$ = total computational cost per second
- $m$ = number of segments processed per second = $1/hopsize$ (constant frame rate) or $f_0$ (pitch-synchronous)
- $C_{segment}^{alg}$ = cost to process one segment = $O(L)$ where $L$ = segment length

### Segment Cost Relationships
$$C_{segment}^{alg} = O(n/f_0) = O(f_0^{-1})$$

Lower fundamental frequency = higher computational cost per segment (and vice versa).

### EpR Harmonic Spectral Envelope (p. 158)
$$S_{harm}(f) = I_{\{f_h, a_h\}_{h=0...H-1}}(f)$$
(Eq. 2.102)

Where:
- $S_{harm}$ = spectral envelope
- $h$ = harmonic index
- $H$ = number of harmonics
- $f_h$ = frequency of $h^{th}$ harmonic
- $a_h$ = amplitude of $h^{th}$ harmonic
- $I$ = interpolation function

### EpR Source Curve (p. 158)
$$Source_{dB}(f) = Gain_{dB} + SlopeDepth_{dB}(e^{Slope \cdot f} - 1)$$
(Eq. 2.103)

Where:
- $Gain$ = gain parameter from linear regression
- $Slope$ = slope parameter from linear regression
- $SlopeDepth$ = depth parameter from linear regression
- Values obtained from linear regression of harmonic peaks in logarithmic frequency spectrum

### Source Resonance Transfer Function (p. 159)
$$H(z) = \frac{A}{1 - Bz^{-1} - Cz^{-2}}$$
(Eq. 2.104)

$$R(f) = R_a \frac{H\left(e^{j2\pi\left(0.5 + \frac{f-R_f}{f_s}\right)}\right)}{H(e^{j\pi})}$$

Based on Klatt 1980 formant synthesizer with:
- $R_f$ = center frequency
- $R_{bw}$ = bandwidth
- $R_a$ = linear amplitude (relative to source curve, 1 = resonance maximum on source curve)

### Resonance Filter Coefficients (p. 159)
$$f_s = \text{Sampling rate}$$
$$C = -e^{\frac{-2\pi R_{bw}}{f_s}}$$
$$B = 2\cos(\pi)e^{\frac{-\pi R_{bw}}{f_s}}$$
$$A = 1 - B - C$$
(Eq. 2.105)

### EpR Residual Envelope (p. 160)
$$S_{residual_{dB}}(f) = I_{\left[f_h, 20\log_{10}(S_{harm}(f_h)) - Source_{dB}(f) - 20\log_{10}\left(\sum_{i=0}^{M} R_i(f)\right)\right]_{h=0...H-1}}(f)$$
(Eq. 2.106)

Where:
- $S_{residual_{dB}}$ = residual spectral envelope in dB
- Stores differences between source plus resonance model and original singer's spectrum
- Captures nuances and details not modeled by source/resonances

## Parameters Found

| Name | Symbol | Units | Value/Range | Notes |
|------|--------|-------|-------------|-------|
| FFT size | T | samples | 512 | Used in harmonic estimation experiments |
| Discontinuity correction | - | - | 0.2, 0.3 | Phase unwrapping correction factor |
| Number of harmonics | - | - | up to 10-16 | Depending on pitch |
| Pitch modulation | - | % | 30 | Used in synthetic test signals |
| Amplitude modulation | - | dB | 15 | Used in synthetic test signals |
| Modulation frequency | - | Hz | f0/4 | Quarter of fundamental frequency |
| Sampling rate | $f_s$ | Hz | 44100 | Standard audio rate |
| Window periods | n | periods | 1-5 | Number of pitch periods covered |
| Source resonance frequency | $R_f$ | Hz | < F1 | Below first formant |
| Source resonance bandwidth | $R_{bw}$ | Hz | - | Klatt-style bandwidth |
| Source resonance amplitude | $R_a$ | linear | 1 = on curve | Relative to source exponential |
| EpR Gain | $Gain_{dB}$ | dB | - | From harmonic regression |
| EpR Slope | $Slope$ | - | - | From harmonic regression |
| EpR SlopeDepth | $SlopeDepth_{dB}$ | dB | - | From harmonic regression |

## Rules/Algorithms

### WBVPM Synthesis via Periodization (p. 141, Fig 2.99)
1. For each synthesis period $m$:
   a. Take spectrum $Q_m(e^{j\Omega})$ (transformed harmonic representation)
   b. Apply IFFT to obtain time-domain signal $q_m[n]$
   c. Create windowed sequence of identical pulses at synthesis pitch rate $T'_m$
   d. Window signal by $h_m[n]/w'_m[n]$ where:
      - $w'_m[n]$ is window whose transform was used in sinusoidal rendering
      - $h_m[n]$ is synthesis overlapping window
   e. Obtain $p'_m[n]$
2. Overlap and add all synthesis pulses at synthesis period locations
3. Resulting signal $v[n]$ is the output audio

### WBVPM Computational Cost Calculation (p. 152-153)
1. Pulse onset computation: Cost proportional to $n/f_0^{min}$
2. Pulse analysis:
   - Segment repetition: O(T)
   - Windowing: O(T)
   - FFT: O(T log_2(T))
   - Sinusoidal estimation: O(number of sinusoids) = O(T)
3. Transformation phase:
   - Pulse onset sequence: O(pulse rate)
   - Timbre envelope estimation: O(number of harmonics) = O(T)
   - Timbre/sinusoidal transformation: O(harmonics) = O(T)
4. Synthesis phase:
   - Sinusoidal rendering: O(sinusoids) = O(T')
   - IFFT: O(T' log_2(T'))
   - Windowing: O(T')
   - Overlap-add: O(T')
5. Total cost = O(f_0) * O(f_0^{-1}) ~ constant (pitch-independent)

### EpR Model Estimation Algorithm (p. 158-160)
1. Estimate harmonic spectral envelope $S_{harm}(f)$ by interpolating harmonics
2. Perform linear regression on harmonic peaks in log-frequency domain to get Gain, Slope, SlopeDepth
3. Compute source curve using exponential decay formula (Eq. 2.103)
4. Add source resonance below F1 if needed (low pitch voices)
5. Estimate vocal tract resonances {$R_1$...$R_M$} as second-order filters
6. Compute residual envelope as difference between model and original spectrum

### Transformation Types (p. 141)
**Period-related transformations (voice source):**
- Time-scaling (period onset sequence scaling)
- Pitch transposition (modify period sequence, repeating/removing/interpolating)

**Individual frequency transformations (vocal tract):**
- Timbre modification via spectral envelope warping $T_{timbre}(f)$
- Phase envelope modification
- Both amplitude and phase should use same scaling function
- Preserve resonance-to-phase relationship by interpolating phase envelope

## Figures of Interest

- **Fig 2.74 (p. 121):** Harmonic amplitude and phase estimation errors for stationary sinusoids, T=512 samples, discontinuity correction 0.2 and 0.3. Shows phase errors concentrated in lower harmonics.

- **Fig 2.75-2.82 (p. 122-129):** Series of WBVPM narrow and wide-band STFT analysis of synthetic signals with varying f0max-f0min ranges (1.10, 3.50, 5.26, 7.02, 10.28, 1.15, 2.15, 0.14 semitones). Demonstrates amplitude/phase spectrum estimation across different pitch modulation scenarios.

- **Fig 2.83-2.86 (p. 130-133):** WBVPM analysis of recorded singing male voice. Shows input audio, repeated period, single period, fundamental frequency tracking, harmonic amplitude/phase errors, and amplitude/phase spectra.

- **Fig 2.87 (p. 134):** Standard vs wide-band sinusoidal model comparison. WBVPM residual is -11.1494 dB below standard model. Shows 3D harmonic amplitude surface and time-domain waveforms.

- **Fig 2.88 (p. 135):** Residual energy comparison across pitch values (50-850 Hz). Wide-band consistently outperforms narrow-band with 1-4 T0 window sizes.

- **Fig 2.89-2.93 (p. 136-140):** Real-world audio examples comparing standard vs wide-band sinusoidal models for various voice types (female singing, male speech, vibrato).

- **Fig 2.94 (p. 142):** Processing scheme for achieving perfect reconstruction of unvoiced signals when no transformations applied.

- **Fig 2.95 (p. 144):** Block diagram of WBVPM analysis phase - pulse onset computation, windowing, FFT, sinusoid estimation flow.

- **Fig 2.96-2.97 (p. 145-146):** Block diagrams of pulse transformation and rendering processes showing timbre envelope estimation, transformation, phase mapping, and sinusoidal rendering.

- **Fig 2.98 (p. 147):** Examples of pulse onset sequence modifications: (a) octave up transposition, (b) 1.5x time-scaling, (c) combined time-varying pitch and time-scale.

- **Fig 2.99 (p. 148):** Block diagram of synthesis phase using periodization method - IFFT, windowing, pulse overlap-add.

- **Fig 2.100 (p. 149):** Voice transformation plug-ins ComboVox and VoiceTransform using NBVPM/WBVPM.

- **Fig 2.101 (p. 150):** Real-time museum installations "The Voice Kaleidoscope" (40" touch display) and "My Voice Produces Waves" (children's installation).

- **Fig 2.103 (p. 153):** Computational cost diagram showing constant total cost for pitch-synchronous algorithm with adapted window.

- **Fig 2.104-2.106 (p. 155-157):** WBVPM real-time performance vs fundamental frequency. Shows 250-700% real-time performance range.

- **Fig 2.107-2.108 (p. 159):** EpR source curve and source resonance diagrams showing Gain, Slope, SlopeDepth parameters.

- **Fig 2.109-2.110 (p. 160):** EpR filter resonances and residual envelopes showing voiced harmonic and residual components.

## Quotes Worth Preserving

> "WBVPM is able to model voice pulses in frequency domain with a set of sinusoids, which represent both harmonic and noisy components. It provides an independent control of each single pulse, thus allowing pulse sequence transformations with ease. This ability is typical of time-domain methods, but complex to achieve in frequency domain, since it implies dealing with complex subharmonics patterns." (p. 142)

> "Compared to NBVPM, WBVPM has the benefits of increased temporal resolution, reduced smearing, and lower computational cost. By contrast, NBVPM is able to decompose the signal into harmonic, transients and noise components, and handle them independently, thus offering a higher control flexibility." (p. 143)

> "The best situation is, however, the combination of a pitch-synchronous algorithm with a window adapted to cover a certain number of pitch periods. That's a good compromise for the time-frequency resolution trade-off. In addition, for such case the cost is almost independent of the pitch of the input signal." (p. 152)

> "WBVPM works in wide-band conditions in such a way that it overcomes the time-frequency analysis constraint where several periods of signal are required in order to achieve enough frequency resolution for estimating harmonic components." (p. 142)

> "The EpR Voice Model (Bonada, Loscos and Cano, et al. 2001) is based on an extension of the well-known source/filter approach (D. G. Childers 1994). It models the magnitude spectral envelope defined by the harmonic spectral peaks of the singer's spectrum. It consists of three filters in cascade." (p. 158)

> "The source resonance is modeled as a symmetric second order filter (based on the Klatt formant synthesizer (Klatt 1980)) with center frequency $R_f$, bandwidth $R_{bw}$ and linear amplitude $R_a$." (p. 159)

## Implementation Notes

### WBVPM Design Considerations
- Window size should cover 3-5 fundamental periods for optimal time-frequency tradeoff
- Pitch detection (MPFA method, Cano 1998) should use window covering n periods of lowest allowed frequency
- Pulse onset detection via MPFA before wide-band analysis ensures periods are centered
- Both harmonic and aspirated noise in voiced signals are represented by sinusoids
- Noise produces amplitude and phase modulations between consecutive periods in pitch-synchronous analysis

### Computational Efficiency
- Synthesis module has much lower cost than analysis module (asymmetric)
- Can process 10 voices simultaneously with saw sweep 13Hz-3kHz
- Processing 11.23 second male voice takes 5.8-6.9 seconds across all transpositions (-24, -12, +12, +24 semitones)
- C++ implementation with periodization achieves real-time on regular computer

### EpR Model Implementation
- Source filter: exponential decay + optional resonance below F1
- Vocal tract filters: M symmetric second-order resonators (same form as Klatt formants)
- Residual envelope: stores dB differences between model prediction and actual harmonic amplitudes
- Allows independent modification of harmonic vs residual components for timbre transformation
- Same representation used for both harmonic and residual components (differ only in gain/slope parameters)

### Window Selection Strategy
- Hanning window recommended for narrow-band analysis
- Window length = n * T0 where n is number of periods (typically 3-5)
- Constant hop-size for frame rate consistency
- Pitch-adapted window length for optimal resolution

### Applications Demonstrated
- ComboVox: VST plug-in for video editing (gender change, robot, alien, monster effects)
- VoiceTransform: SALERO project VST plug-in with pitch/vibrato, frequency controls, amplitude/breathiness
- The Voice Kaleidoscope: 40" touch display museum installation
- My Voice Produces Waves: Children's interactive installation (ages 7-9)
- MyTinyPlanets: Flash video game using WBVPM for character voices
- Web service for offline voice transformation
