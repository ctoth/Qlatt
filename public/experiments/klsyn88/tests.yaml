suite: klsyn88-semantics-and-schedule
semantics: public/experiments/klsyn88/semantics.yaml
graph: public/experiments/klsyn88/graph.yaml
registry: public/experiments/klsyn88/registry.yaml
defaultTol: 1e-6

tests:
  - name: avDb clamps below zero
    inputs:
      AV: 5
    assert:
      approx:
        avDb: 0
        voiceGain: 0

  - name: gain0Db uses fallback when GO-3 <= 0
    inputs:
      GO: 3
    assert:
      approx:
        gain0Db: 57

  - name: gain0Db uses GO-3 when GO-3 > 0
    inputs:
      GO: 40
    assert:
      approx:
        gain0Db: 37

  - name: gain0Linear includes 32768 normalization for WebAudio
    # klsyn88 fixed-point to float conversion: dbToLinearKlsyn(54) * (1/32768)
    # At GO=57, gain0Db=54, amptable[54]=719, so:
    # gain0Linear = 719 * 0.001 * 3.0517578125e-5 â‰ˆ 2.1942e-5
    inputs:
      GO: 57
    assert:
      approx:
        gain0Linear: 2.1942e-5
      tol: 1e-8

  - name: cascadePolarity flips on even NFCASC
    inputs:
      NFCASC: 6
    assert:
      approx:
        cascadePolarity: -1

  - name: cascadeF7/F8 gating off below thresholds
    inputs:
      NFCASC: 6
    assert:
      approx:
        cascadeF7Freq: 0
        cascadeF8Freq: 0

  - name: cascadeF7/F8 active at NFCASC >= 8
    inputs:
      NFCASC: 8
    assert:
      approx:
        cascadeF7Freq: 6500
        cascadeF8Freq: 7500

  - name: parallel gain signs alternate
    inputs:
      A2: 40
      A3: 40
      A4: 40
      A5: 40
      A6: 40
    assert:
      expr:
        - "a2Gain < 0"
        - "a3Gain > 0"
        - "a4Gain < 0"
        - "a5Gain > 0"
        - "a6Gain < 0"
