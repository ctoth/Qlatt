# Klatt 80 Synthesizer Primitive Registry
# Defines all node types available for the Klatt audio graph
#
# Each primitive defines:
#   - description: What the node does
#   - category: webaudio | wasm-worklet | js-worklet
#   - worklet: path to processor JS (for worklet types)
#   - wasm: path to WASM module (for wasm-worklet types)
#   - parameters: configurable params with type, default, unit, description
#   - inputs: number of audio inputs
#   - outputs: number of audio outputs

version: "1.0"

primitives:
  # ===========================================================================
  # WebAudio Native Nodes
  # ===========================================================================

  gain:
    description: "WebAudio GainNode - multiplies input signal by gain parameter"
    category: "webaudio"
    parameters:
      gain:
        type: float
        default: 1.0
        description: "Multiplication factor (linear scale)"
    inputs: 1
    outputs: 1

  constant-source:
    description: "WebAudio ConstantSourceNode - outputs constant value"
    category: "webaudio"
    parameters:
      offset:
        type: float
        default: 1.0
        description: "Constant output value"
    inputs: 0
    outputs: 1

  # ===========================================================================
  # WASM-backed AudioWorklet Nodes
  # ===========================================================================

  resonator:
    description: "Two-pole resonator (formant filter) - implements second-order IIR bandpass"
    category: "wasm-worklet"
    worklet: "resonator-processor.js"
    wasm: "resonator.wasm"
    options:
      bypassAtZero:
        type: boolean
        default: false
        description: "When true, bypass filter if frequency is 0"
    parameters:
      frequency:
        type: float
        unit: "Hz"
        default: 500
        description: "Center frequency of the resonance"
      bandwidth:
        type: float
        unit: "Hz"
        default: 100
        description: "3dB bandwidth"
    inputs: 1
    outputs: 1

  antiresonator:
    description: "Two-zero antiresonator (zero filter) - implements second-order IIR notch for nasal zeros"
    category: "wasm-worklet"
    worklet: "antiresonator-processor.js"
    wasm: "antiresonator.wasm"
    options:
      bypassAtZero:
        type: boolean
        default: false
        description: "When true, bypass filter if frequency is 0"
    parameters:
      frequency:
        type: float
        unit: "Hz"
        default: 500
        description: "Zero frequency"
      bandwidth:
        type: float
        unit: "Hz"
        default: 100
        description: "3dB bandwidth"
    inputs: 1
    outputs: 1

  lf-source:
    description: "LF model glottal source with Rd voice quality control - generates glottal flow derivative"
    category: "wasm-worklet"
    worklet: "lf-source-processor.js"
    wasm: "lf-source.wasm"
    parameters:
      f0:
        type: float
        unit: "Hz"
        default: 120
        description: "Fundamental frequency"
      rd:
        type: float
        default: 1.0
        description: "Voice quality parameter (0.3=pressed to 2.7=breathy)"
      lfMode:
        type: int
        default: 1
        description: "LF model mode selection"
    inputs: 0
    outputs: 1

  signal-switch:
    description: "N-to-1 signal selector implementing Klatt 80 SW parameter - instantaneous switching between cascade/parallel branches"
    category: "wasm-worklet"
    worklet: "signal-switch-processor.js"
    wasm: "signal-switch.wasm"
    parameters:
      selector:
        type: float
        default: 0
        description: "Branch selector (0=cascade/input0, 1=parallel/input1)"
    inputs: 2
    outputs: 1

  edge-detector:
    description: "Klatt 80 PLSTEP trigger detector - fires single-sample pulse when input increases by >= threshold"
    category: "wasm-worklet"
    worklet: "edge-detector-processor.js"
    wasm: "edge-detector.wasm"
    parameters:
      threshold:
        type: float
        unit: "dB"
        default: 49.0
        description: "Delta threshold to trigger (Klatt 80 uses 49 dB for AF/AH)"
      input:
        type: float
        unit: "dB"
        default: 0
        description: "Input parameter value to monitor (typically AF or AH amplitude)"
    inputs: 0
    outputs: 1

  decay-envelope:
    description: "Klatt 80 PLSTEP exponential decay envelope - triggered burst with 0.995 per-sample decay at 10kHz"
    category: "wasm-worklet"
    worklet: "decay-envelope-processor.js"
    wasm: "decay-envelope.wasm"
    parameters:
      trigger:
        type: float
        default: 0
        description: "Trigger input (rising edge >0.5 fires envelope)"
        automationRate: "a-rate"
      amplitude:
        type: float
        default: 1.0
        description: "Initial envelope amplitude when triggered (sets to -amplitude for rarefaction)"
        automationRate: "a-rate"
      decay:
        type: float
        default: 0
        description: "Per-sample decay coefficient (0=auto from sample rate, Klatt 80 uses 0.995 at 10kHz)"
        automationRate: "k-rate"
    inputs: 0
    outputs: 1

  # ===========================================================================
  # JavaScript AudioWorklet Nodes
  # ===========================================================================

  impulse-train:
    description: "Classic Klatt impulse train source - generates periodic impulses at F0"
    category: "js-worklet"
    worklet: "impulse-train-processor.js"
    parameters:
      f0:
        type: float
        unit: "Hz"
        default: 120
        description: "Fundamental frequency"
      gain:
        type: float
        default: 1.0
        description: "Impulse amplitude"
      openPhaseRatio:
        type: float
        default: 0.7
        description: "Open phase ratio (OQ) for impulse shaping"
    inputs: 0
    outputs: 1

  noise-source:
    description: "Filtered noise generator for aspiration and frication"
    category: "js-worklet"
    worklet: "noise-source-processor.js"
    parameters:
      gain:
        type: float
        default: 1.0
        description: "Noise amplitude"
      cutoff:
        type: float
        unit: "Hz"
        default: 4000
        description: "Lowpass filter cutoff frequency"
    inputs: 1    # Accepts modulation input for glottal sync
    outputs: 1

  differentiator:
    description: "First-difference filter for radiation characteristic - y[n] = x[n] - x[n-1]"
    category: "js-worklet"
    worklet: "differentiator-processor.js"
    parameters: {}
    inputs: 1
    outputs: 1

  glottal-mod:
    description: "Amplitude modulation synchronized to glottal cycle - 50% duty cycle square wave"
    category: "js-worklet"
    worklet: "glottal-mod-processor.js"
    parameters:
      f0:
        type: float
        unit: "Hz"
        default: 120
        description: "Fundamental frequency for synchronization"
    inputs: 1
    outputs: 1
