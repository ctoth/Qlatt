# Pages 000-039 Notes

## Chapters/Sections Covered
- **Front Matter**: Title page, copyright, doctoral direction, abstracts (English, Catalan, Spanish), acknowledgements, dedication, table of contents, notations
- **Chapter 1: Introduction** (pages 20-29)
  - 1.1 Motivation
  - 1.2 Goals
  - 1.3 Singing Voice Production
  - 1.4 Singing Voice Synthesis
  - 1.5 Organization of the thesis work
- **Chapter 2: Voice Processing by Spectral Models** (pages 30-39, partial)
  - 2.1 Harmonic estimation (pages 33-39)

## Key Findings

### Dissertation Overview
- PhD dissertation by Jordi Bonada Sanjaume (2008) at Universitat Pompeu Fabra, Barcelona
- Supervised by Dr. Xavier Serra at Music Technology Group
- Research funded by Yamaha Corp; significant portion incorporated into Vocaloid commercial singing synthesizer
- Won first Rosina Ribalta prize 2007 (EPSON Foundation) for best PhD thesis in IT/Communications

### Voice Production Model (Chapter 1)
- Singing voice modeled as source-filter system (Fant 1986 LF model)
- Voice source signal $s_{vs}(t)$ corresponds to *source*, vocal/nasal tracts constitute *filter*
- Filter typically modeled as ARMA (AutoRegressive Moving Average) followed by differentiator
- AR filter represents formants of vocal tract
- MA filter models antiresonances (coupling between vocal and nasal tracts)
- Differentiator filter represents lip radiation effect
- Under LTI assumption, filter order can be changed - common practice to replace ARMA with just AR filter

### Voice Source Parameters (Table 1.1)
- $T_0$ - period duration (inverse of vocal fold vibration frequency)
- $\hat{U}$ - flow amplitude (maximum glottal flow amplitude)
- $T_{op}$ - open phase duration
- $T_{cl}$ - closed phase duration
- $Q_{closed}$ - closed quotient ($T_{cl}/T_0$)
- $DC$ flow - mean flow during closed phase (glottal leakage)
- $PtP$ - peak-to-peak flow (difference between $\hat{U}$ and DC flow)
- $MFDR$ - maximum flow declination rate (peak speed of flow decrease during closing phase)

### Synthesis Approaches Discussed
1. **Physical Models**: Model actual production mechanisms with differential equations
2. **Spectral Models**: Deal with frequency domain content; parameters map to auditory perception (pitch, formant frequencies/bandwidths, glottal pulse shape, spectral tilt)
3. **Formant-based Synthesis**: Pseudo-physical spectral models using source-filter decomposition; Klatt synthesizer noted as "most known system"
4. **Formant Wave Synthesis (FOF)**: Time-domain models of formant impulse responses; most known is FOF synthesizer in CHANT
5. **Concatenative Synthesis**: Transform and concatenate recorded samples; this dissertation's approach

### Key Design Goal
- Build singing voice synthesizer capable of reproducing specific singer's voice
- Inputs: only score and lyrics
- Output: natural sounding synthesis matching singer's expression and timbre
- Approach combines spectral models with source-filter decomposition

## Equations Found

### Fourier Transform of Sinusoid (Eq. 2.1)
$$x(t) = A\cos(2\pi f_0 t)$$
$$X(f) = FT[x](t) = \int_{-\infty}^{\infty} A \frac{e^{j2\pi f_0 t} + e^{-j2\pi f_0 t}}{2} e^{-j2\pi ft} dt = \frac{A}{2}[\delta(f-f_0) + \delta(f+f_0)]$$

Where:
- $A$ = sinusoid amplitude
- $f_0$ = fundamental frequency
- $\delta$ = Dirac delta function

### Discrete Sinusoid (Eq. 2.2)
$$x(t) = \begin{cases} A\cos(2\pi f_0 t) & \text{if } t = nT_s, \forall n \in \mathbb{Z} \\ 0 & \text{otherwise} \end{cases} \implies x(n) = A\cos(2\pi f_0 n T_s)$$

### Short-Time Fourier Transform (STFT) (Eq. 2.3)
$$X_w(k) = \sum_{n=0}^{N-1} w(n)x(n)e^{-j2\pi nk/N} \quad k = 0,1,...,N-1$$

$$w(n)x(n) = \frac{1}{N} \sum_{k=0}^{N-1} X_w(k)e^{j2\pi nk/N} \quad n = 0,1,...,N-1$$

Where:
- $w(n)$ = analysis window
- $N$ = FFT size
- $k$ = frequency bin index

### Sinusoidal Signal Model (Eq. 2.4)
$$s(t) = \sum_{h=0}^{H-1} a_h(t)\cos(\theta_h(t))$$

Where:
- $H$ = number of partials (harmonics)
- $a_h(t)$ = amplitude of $h^{th}$ harmonic
- $\theta_h(t)$ = phase of $h^{th}$ harmonic

### Phase-Frequency Relationship (Eq. 2.5)
$$\frac{\partial \theta_h}{\partial t} = 2\pi f_h(t) \quad \theta_h(t) = \theta_h(0) + 2\pi \int_0^t f_h(\tau)d\tau$$

Where:
- $f_h$ = frequency of $h^{th}$ partial

### Sinusoid Derivative (Eq. 2.6)
$$\frac{\partial s}{\partial t}(t) = \sum_{h=1}^{H-1} 2\pi f_h(t) a_h(t) \cos\left(\theta_h(t) - \frac{\pi}{2}\right)$$

### Derivative DFT (Eq. 2.7)
$$DFT^p(k) = \frac{1}{N} \left| \sum_{n=0}^{N-1} w(n) \frac{\partial^p s}{\partial t^p}(n) e^{-j\frac{2\pi kn}{N}} \right|$$

### Frequency Estimation from DFT (Eq. 2.8-2.9)
$$f_h^0 = k_h \frac{f_s}{N} \quad a_h^0 = DFT^0(k_h)$$

$$f_h^1 = \frac{1}{2\pi} \frac{DFT^1(k_h)}{DFT^0(k_h)} \quad a_h^1 = \frac{a_h^0}{W(f_h^1 - f_h^0)}$$

Where:
- $f_s$ = sampling rate
- $W(f)$ = continuous spectrum of analysis window

### Triangle Algorithm Window (Eq. 2.10-2.11)
$$A(e^{j\Omega}) = \begin{cases} 1 - \frac{|\Omega|}{\Omega_c} & |\Omega| < \Omega_c \\ 0 & \text{otherwise} \end{cases}$$

$$h_1(k) = ak + b \quad h_2(k) = -a(k-D) + b$$

Optimal cutoff: $\Omega_c = 8\pi/N$

### Time-Frequency Reassignment (Eq. 2.12-2.13)
$$\hat{f}_k = k\frac{f_s}{N} - \Im\left\{\frac{X_{dw}(k)X_w^*(k)}{|X_w(k)|^2}\right\} \cdot \frac{f_s}{2\pi}$$

$$\hat{t}_m = t_m + \Re\left\{\frac{X_{dw}(k)X_w^*(k)}{|X_w(k)|^2}\right\}$$

Where:
- $X_{dw}$ = STFT using window derivative
- $\Im$ = imaginary part
- $\Re$ = real part

### Phase Vocoder Frequency Estimation (Eq. 2.14)
$$\hat{f}_k = \frac{f_s}{2\pi} \cdot \frac{\text{princarg}\{\angle X_w^{m+R}(k) - \angle X_w^m(k)\}}{R}$$

Where:
- $R$ = hop size in samples

### Linear AM-FM Sinusoid (Eq. 2.15-2.17)
$$s(n) = (a_0 + a_1 n)e^{j(\theta_0 + 2\pi\omega_0 n + \pi D n^2)}$$

$$S(\omega) = \sum_{n=-\infty}^{\infty} w(n)(a_0 + a_1 n)e^{j(\theta_0 + 2\pi\omega_0 n + \pi D n^2)} e^{-j2\pi\omega n}$$

$$S_1(\omega) = a_0 e^{j\theta_0} \sum_{n=-\infty}^{\infty} w(n)\cos(2\pi(\omega_0 - \omega)n)e^{j\pi D n^2}$$

$$S_2(\omega) = a_1 e^{j\theta_0} \sum_{n=-\infty}^{\infty} w(n)nj\sin(2\pi(\omega_0 - \omega)n)e^{j\pi D n^2}$$

Where:
- $a_0, a_1$ = amplitude parameters (linear modulation)
- $\omega_0$ = center frequency
- $D$ = frequency modulation rate (chirp)

## Parameters Found

| Name | Symbol | Units | Value/Range | Notes |
|------|--------|-------|-------------|-------|
| Period duration | $T_0$ | seconds | varies | Inverse of f0 |
| Flow amplitude | $\hat{U}$ | - | - | Maximum glottal flow |
| Open phase duration | $T_{op}$ | seconds | - | Vocal folds separated |
| Closed phase duration | $T_{cl}$ | seconds | - | Vocal folds closed |
| Closed quotient | $Q_{closed}$ | ratio | $T_{cl}/T_0$ | Ratio of closed to period |
| DC flow | $DC$ | - | - | Mean flow during closure (leakage) |
| Peak-to-peak flow | $PtP$ | - | - | $\hat{U} - DC$ |
| Max flow declination rate | $MFDR$ | 1/s | - | Peak negative derivative |
| Sampling frequency | $f_s$ | Hz | - | - |
| Sampling interval | $T_s$ | seconds | $1/f_s$ | - |
| FFT size | $N$ | samples | 1024, 2048, 4096, 8192 | Powers of 2 typical |
| Window length | $L$ | samples | - | Analysis window |
| Main lobe bandwidth | $B$ | bins | $B \approx C/L$ | $C$ depends on window type |
| Zero-padding factor | - | ratio | 8, 1000 | For frequency accuracy |
| Triangle window cutoff | $\Omega_c$ | radians | $8\pi/N$ | Optimal compromise |
| Hop size | $R$ | samples | - | Frame advance |

## Rules/Algorithms

### Quadratic Interpolation for Spectral Peak Estimation
1. Find local maximum in magnitude spectrum at bin $k_p$
2. Get three adjacent magnitude values: $a = X_w^{dB}(k_p-1)$, $b = X_w^{dB}(k_p)$, $c = X_w^{dB}(k_p+1)$
3. Estimated sinusoid frequency in bins: $\hat{k}_p = k_p + (a-c)/2(a-2b+c)$
4. Estimated amplitude: $\hat{a}_p = b - (a-c)^2/8(a-2b+c)$
5. Phase estimated by interpolating unwrapped phase with 2nd order polynomial at estimated frequency

### Derivative Algorithm for Harmonic Estimation
1. Compute both $DFT^0$ and $DFT^1$ (first derivative) spectra
2. For each partial $h$, find maximum in $DFT^0$ at index $k_h$
3. Compute approximate frequency: $f_h^0 = k_h \cdot f_s/N$
4. Compute refined frequency from derivative: $f_h^1 = \frac{1}{2\pi} \frac{DFT^1(k_h)}{DFT^0(k_h)}$
5. Compute refined amplitude: $a_h^1 = a_h^0 / W(f_h^1 - f_h^0)$
6. Window should be as short as possible with only constraint: partials must lie in two different FFT bins

### Triangle Algorithm for Sinusoid Parameters
1. Use triangular analysis window with zero-phase response
2. Find local maximum at $k_m$
3. Take 6 closest spectral values surrounding $X_m(k_m)$
4. Fit two lines $h_1(k) = ak + b$ and $h_2(k) = -a(k-D) + b$ by minimizing squared error
5. Determine peak by $k_0 = 2 - b/a$
6. Performs better than derivative algorithm in noisy situations; derivative better at low noise

### Time-Frequency Resolution Tradeoff
1. Long analysis windows: high frequency resolution, poor temporal resolution
2. Short analysis windows: poor frequency resolution, high temporal resolution
3. Main lobe width $B$ inversely proportional to window length $L$: $B \approx C/L$
4. For singing voice with vibratos: need windows adapting to pitch changes

## Figures of Interest

- **Fig 1.1 (p. 24):** Voice organ diagram showing airstream flow, vocal folds, vocal tract, formants spectrum, and radiated spectrum. Key: voice source decays ~6 dB/octave; formants enhance certain frequencies.

- **Fig 1.2 (p. 25):** Pressure waveform, estimated voice source, and voice source derivative for /a/ vowel sung by male. Shows LF model (Fant 1986) fitting.

- **Fig 1.3 (p. 25):** Source-filter model diagram. Two versions shown: (1) voice source -> vocal/nasal tracts (ARMA) -> radiation -> p(t), (2) Under LTI assumption: voice source derivative -> radiation -> vocal/nasal tracts (ARMA) -> p(t)

- **Fig 1.4 (p. 26):** Glottis opening/closing cycle. Three views: recorded waveform, simulated glottal flow (LF model), glottal flow derivative. Shows GCI (Glottal Closure Instants) marking, opening phase, closing phase patterns.

- **Fig 1.5 (p. 26):** Waveform + laryngograph signal. Peaks in laryngograph signal mark GCIs. Data from Keele Pitch Database.

- **Fig 2.1 (p. 32):** Harmonic signals as time-varying sinusoids vs. voice pulse train. Key insight: temporal periodicity T <-> frequency periodicity 1/T. Three interpretations shown: (a) pulse train with varying period, (b) filtered pulses, (c) bank of oscillators.

- **Fig 2.2 (p. 33):** FT of stationary sinusoid showing delta peaks at $\pm f_0$ with amplitude $A/2$.

- **Fig 2.3 (p. 33):** DTFT of sampled sinusoid showing spectral replication at multiples of sampling frequency.

- **Fig 2.4 (p. 34):** Window convolution effect - signal spectrum convolved with window spectrum, showing N spectrum values and Nyquist limit.

- **Fig 2.5 (p. 37):** Triangle window amplitude response. Cutoff $\Omega_c = 8\pi/N$ provides good compromise between frequency resolution and noisy sinusoid detection.

- **Fig 2.6 (p. 39):** STFT of stationary 200 Hz sinusoid. Shows Blackman-Harris window, zero-padding by 8, amplitude spectrum (max at 200 Hz, -6 dB), phase spectrum (constant under main lobe, random at -92 dB).

- **Fig 2.7 (p. 40):** Window length effect on frequency resolution. Long windows (L=8192, 4096) resolve harmonics clearly; short windows (L=2048, 1024) cause harmonic overlap.

- **Fig 2.8 (p. 40):** Close frequency components (100+105 Hz, 200+210 Hz, etc.) cause window transform overlap, appearing as single component.

## Quotes Worth Preserving

> "The singing voice is probably the most complex musical instrument and the richest one with respect to expressive nuances." (p. 21)

> "Cascade structures are more suited for non-nasal voiced sounds, while parallel structures have found to be better for nasals, fricatives and stop-consonants. The most known system is the Klatt Formant Synthesizer (Klatt 1980), which has been incorporated in several TTS systems." (p. 28)

> "Voiced utterances can be interpreted as (1) a set of time-varying quasi-sinusoidal signals looking at the frequency axis, or (2) as a sequence of voice pulses looking at the temporal axis." (p. 31)

> "A common problem of the first interpretation (1) is the one of *shape variance*: the loss of the intrinsic phase synchronization between harmonics found in voice signals, also called *phase-coherence*." (p. 31)

> "The width B of the main lobe of the window transform is inversely proportional to the length L of the analysis window." (p. 34)

## Implementation Notes

### Window Selection
- Blackman-Harris 92 dB window commonly used (sidelobe suppression at -92 dB)
- Window choice affects time-frequency resolution tradeoff
- For vibratos: need adaptive windowing or short windows with robust estimation

### Zero-Padding
- Zero-padding factor of 8 typical for visualization
- Factor of 1000 needed for 0.1% frequency accuracy with quadratic interpolation
- More efficient: use derivative algorithm with smaller zero-padding

### Spectral Estimation Challenges
1. **Close frequency components**: Harmonics may overlap in short windows
2. **Non-stationary sinusoids**: AM/FM modulation distorts spectral shape
3. **Sinusoids near boundaries**: DC (0 Hz) and Nyquist ($f_s/2$) cause folding artifacts
4. **Noise**: Reduces peak detection accuracy
5. **Transients**: Signals starting/ending within window broaden spectral peaks

### Data Structures for Harmonic Trajectories
- Frame-by-frame storage: for each frame $m$, store $\kappa_{h,m} = (a_{h,m}, f_{h,m}, \theta_{0,h,m})$
- $a_{h,m}$ = amplitude of harmonic $h$ at frame $m$
- $f_{h,m}$ = frequency of harmonic $h$ at frame $m$
- $\theta_{0,h,m}$ = phase at time zero (n=0) for harmonic $h$ at frame $m$

### Transformation Functions (Notations p. 18-19)
- $T_{pitch}$ - pitch transposition ratio (output/input frequencies)
- $T_{time}$ - time scaling ratio (output/input durations)
- $T_{timbre}$ - timbre scaling ratio (frequency mapping)
- $\bar{T}_{pitch}(t)$ - time-varying pitch transformation function
- $\bar{T}_{time}(t)$ - time mapping function between input/output
- $\bar{T}_{timbre}(f)$ - frequency mapping function between input/output

### Key Abbreviations
- NBVPM - Narrow-Band Voice Pulse Modeling
- WBVPM - Wide-Band Voice Pulse Modeling
- MFPA - Maximally Flat Phase Alignment
- EpR - Excitation plus Resonances (spectral voice model)
- GCI - Glottal Closure Instant
- PSOLA - Pitch-Synchronous Overlap-Add
