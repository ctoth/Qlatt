# klsyn88 Synthesizer Semantics
# Matches klsyn88 parwav.c parameter mapping and gain scaling.

bacon: "0.1"
name: klsyn88

params:
  F0:
    type: float
    range: [0, 500]
    default: 0
    unit: Hz

  F1:
    type: float
    range: [200, 1300]
    default: 500
    unit: Hz
  F2:
    type: float
    range: [550, 3000]
    default: 1500
    unit: Hz
  F3:
    type: float
    range: [1200, 4999]
    default: 2500
    unit: Hz
  F4:
    type: float
    range: [1200, 4999]
    default: 3500
    unit: Hz
  F5:
    type: float
    range: [1200, 4999]
    default: 4500
    unit: Hz
  F6:
    type: float
    range: [1200, 4999]
    default: 5500
    unit: Hz

  B1:
    type: float
    range: [40, 1000]
    default: 60
    unit: Hz
  B2:
    type: float
    range: [40, 1000]
    default: 90
    unit: Hz
  B3:
    type: float
    range: [40, 1000]
    default: 150
    unit: Hz
  B4:
    type: float
    range: [40, 1000]
    default: 200
    unit: Hz
  B5:
    type: float
    range: [40, 1000]
    default: 200
    unit: Hz
  B6:
    type: float
    range: [40, 2000]
    default: 500
    unit: Hz

  B1p:
    type: float
    range: [40, 1000]
    default: 80
    unit: Hz
  B2p:
    type: float
    range: [40, 1000]
    default: 200
    unit: Hz
  B3p:
    type: float
    range: [40, 1000]
    default: 350
    unit: Hz
  B4p:
    type: float
    range: [40, 1000]
    default: 500
    unit: Hz
  B5p:
    type: float
    range: [40, 1000]
    default: 600
    unit: Hz
  B6p:
    type: float
    range: [40, 2000]
    default: 800
    unit: Hz

  FNZ:
    type: float
    range: [248, 528]
    default: 270
    unit: Hz
  BNZ:
    type: float
    range: [40, 1000]
    default: 90
    unit: Hz
  FNP:
    type: float
    range: [248, 528]
    default: 270
    unit: Hz
  BNP:
    type: float
    range: [40, 1000]
    default: 90
    unit: Hz

  GO:
    type: float
    range: [0, 60]
    default: 57
    unit: dB
    description: "Overall gain (Gain0)"

  AV:
    type: float
    range: [0, 70]
    default: 0
    unit: dB
  AVS:
    type: float
    range: [0, 70]
    default: 0
    unit: dB
  AH:
    type: float
    range: [0, 70]
    default: 0
    unit: dB
  AF:
    type: float
    range: [0, 80]
    default: 0
    unit: dB

  A1:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  A2:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  A3:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  A4:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  A5:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  A6:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  AN:
    type: float
    range: [0, 80]
    default: 0
    unit: dB
  AB:
    type: float
    range: [0, 80]
    default: 0
    unit: dB

  dF1hz:
    type: float
    range: [0, 500]
    default: 0
    unit: Hz
  dB1hz:
    type: float
    range: [0, 500]
    default: 0
    unit: Hz

  ss:
    type: int
    range: [1, 4]
    default: 2
    description: "Source select: 1=impulsive, 2=natural, 3=triangular, 4=square"

  Kopen:
    type: float
    range: [0, 100]
    default: 50
    description: "Open quotient percent"

  Kskew:
    type: float
    range: [0, 200]
    default: 0
    description: "Skewness"

  as:
    type: float
    range: [0, 100]
    default: 50
    description: "Triangular asymmetry percent"

  Aturb:
    type: float
    range: [0, 80]
    default: 0
    unit: dB

  TLTdb:
    type: float
    range: [0, 34]
    default: 0
    unit: dB

  NFCASC:
    type: int
    range: [1, 8]
    default: 6
    description: "Number of cascade formants"

  seed:
    type: int
    range: [1, 2147483647]
    default: 1
    description: "Random seed"

constants:
  F7: 6500
  B7: 500
  F8: 7500
  B8: 600

realize:
  avDb:
    expr: "max(AV - 7, 0)"
    deps: [AV]

  voiceGain:
    expr: "dbToLinearKlsyn(avDb)"
    deps: [avDb]

  parVoiceGain:
    expr: "dbToLinearKlsyn(AVS)"
    deps: [AVS]

  aspGain:
    expr: "dbToLinearKlsyn(AH) * 0.05"
    deps: [AH]

  fricGain:
    expr: "dbToLinearKlsyn(AF) * 0.25"
    deps: [AF]

  a1Gain:
    expr: "dbToLinearKlsyn(A1) * 0.4"
    deps: [A1]

  a2Gain:
    expr: "-dbToLinearKlsyn(A2) * 0.15"
    deps: [A2]

  a3Gain:
    expr: "dbToLinearKlsyn(A3) * 0.06"
    deps: [A3]

  a4Gain:
    expr: "-dbToLinearKlsyn(A4) * 0.04"
    deps: [A4]

  a5Gain:
    expr: "dbToLinearKlsyn(A5) * 0.022"
    deps: [A5]

  a6Gain:
    expr: "-dbToLinearKlsyn(A6) * 0.03"
    deps: [A6]

  anpGain:
    expr: "dbToLinearKlsyn(AN) * 0.6"
    deps: [AN]

  abGain:
    expr: "dbToLinearKlsyn(AB) * 0.05"
    deps: [AB]

  gain0Db:
    expr: "(GO - 3) <= 0 ? 57 : (GO - 3)"
    deps: [GO]

  # klsyn88 fixed-point to WebAudio float normalization:
  # The C implementation (parwav.c) works in 16-bit fixed-point throughout,
  # with glottal sources emitting values up to Â±13,000,000 (DOUBLET constant).
  # At output, parwv_truncate() clamps to [-32768, 32767] before writing PCM.
  # Our WASM primitives emit the same raw klsyn88-scale values, but WebAudio
  # expects [-1, 1] floats. Multiplying by 1/32768 here (where amp_gain0 is
  # applied in C, just before truncation) normalizes to the correct output range.
  gain0Linear:
    expr: "dbToLinearKlsyn(gain0Db) * 0.000030517578125"
    deps: [gain0Db]

  cascadePolarity:
    expr: "NFCASC % 2 == 0 ? -1 : 1"
    deps: [NFCASC]

  cascadeF2Freq:
    expr: "NFCASC >= 2 ? F2 : 0"
    deps: [NFCASC, F2]

  cascadeF2Bw:
    expr: "NFCASC >= 2 ? B2 : 0"
    deps: [NFCASC, B2]

  cascadeF3Freq:
    expr: "NFCASC >= 3 ? F3 : 0"
    deps: [NFCASC, F3]

  cascadeF3Bw:
    expr: "NFCASC >= 3 ? B3 : 0"
    deps: [NFCASC, B3]

  cascadeF4Freq:
    expr: "NFCASC >= 4 ? F4 : 0"
    deps: [NFCASC, F4]

  cascadeF4Bw:
    expr: "NFCASC >= 4 ? B4 : 0"
    deps: [NFCASC, B4]

  cascadeF5Freq:
    expr: "NFCASC >= 5 ? F5 : 0"
    deps: [NFCASC, F5]

  cascadeF5Bw:
    expr: "NFCASC >= 5 ? B5 : 0"
    deps: [NFCASC, B5]

  cascadeF6Freq:
    expr: "NFCASC >= 6 ? F6 : 0"
    deps: [NFCASC, F6]

  cascadeF6Bw:
    expr: "NFCASC >= 6 ? B6 : 0"
    deps: [NFCASC, B6]

  cascadeF7Freq:
    expr: "NFCASC >= 7 ? F7 : 0"
    deps: [NFCASC, F7]

  cascadeF7Bw:
    expr: "NFCASC >= 7 ? B7 : 0"
    deps: [NFCASC, B7]

  cascadeF8Freq:
    expr: "NFCASC >= 8 ? F8 : 0"
    deps: [NFCASC, F8]

  cascadeF8Bw:
    expr: "NFCASC >= 8 ? B8 : 0"
    deps: [NFCASC, B8]
